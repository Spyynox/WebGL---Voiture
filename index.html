<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        body { margin: 0; }
        canvas { width: 100%; height: 100%; }
    </style>
</head>
<body>
    <button id="button">Start</button>
    <!-- <script src="//cdn.rawgit.com/mrdoob/three.js/master/build/three.min.js"></script> -->
    <script src="https://unpkg.com/three@0.87.1/build/three.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stats.js/r16/Stats.min.js"></script>
    <script src="https://unpkg.com/three@0.87.1/examples/js/controls/OrbitControls.js"></script>
    <script src="https://unpkg.com/three@0.87.1/examples/js/loaders/GLTFLoader.js"></script>
    <script type="module">
        // import * as THREE from 'https://threejsfundamentals.org/threejs/resources/threejs/r115/build/three.module.js';
        // import {FBXLoader} from 'https://threejsfundamentals.org/threejs/resources/threejs/r115/examples/jsm/loaders/FBXLoader.js';
        // import {GLTFLoader} from 'https://threejsfundamentals.org/threejs/resources/threejs/r115/examples/jsm/loaders/GLTFLoader.js';
        
        const SKY_WIDTH = 3000;
        const SKY_HEIGHT = 500;
        const GROUND_Y = -10;
        const GROUND_WIDTH = 2000;
        const GROUND_LENGTH = 800;
        const ROAD_WIDTH = 12;
        const ROAD_LENGTH = 400;
        const CAMERA_OFFSET_X = 0;
        const CAMERA_OFFSET_Y = 1.333;
        const CAMERA_OFFSET_Z = 5;

        var camera, scene, renderer, stats, player, player2, controls;

        document.getElementById("button").addEventListener("click", e => {
            e.target.style = "display: none;"
            init();
            animate();
        })

        var circleDirection = 1

        function init() {

            scene = new THREE.Scene();

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000 );

            createGround();
            createRoad();
            createSky();
            createLight();
            createPorsche();
            createPickUp();

            renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth, window.innerHeight);
            // renderer.outputEncoding = THREE.sRGBEncoding;

            document.body.appendChild(renderer.domElement);

            stats = new Stats();
            stats.showPanel( 1 );
            stats.domElement.style.cssText = 'position:absolute;top:0px;left:0px;';
            document.body.appendChild( stats.domElement );

            playAudio();
        }

        function animate() {

            stats.begin();
            requestAnimationFrame(animate);
            render();
            stats.end();
        }

        function render() {
            updateCamera();

            if ((player && player2) && player.position.z <= -100) {
                player.position.z = -0.5
                player2.position.z = -0.5
                camera.position.z = 0
            }

            renderer.render(scene, camera);
        }

        function updateCamera() {
            if (player && player2) {
                camera.translateZ(-0.6);
                player.translateZ(-0.6);
                player2.translateZ(0.6);
            }
        }

        document.addEventListener('keydown', e => {
            if (e.keyCode === 37) {
                player.translateX(-0.005);
            }

            if (e.keyCode === 39) {
                player.translateX(0.005);
            }

            if (e.keyCode === 81) {
                player2.translateX(0.005);
            }

            if (e.keyCode === 68) {
                player2.translateX(-0.005);
            }
        })

        function createSky() {
            var texture = THREE.ImageUtils.loadTexture('images/clouds1273.jpg');
            texture.wrapS = texture.wrapT = THREE.MirroredRepeatWrapping;
            texture.repeat.set(1, 1);
            var sky = new THREE.Mesh( new THREE.PlaneGeometry(SKY_WIDTH, SKY_HEIGHT), 
			new THREE.MeshBasicMaterial({ color: 0x3fafdd, map:texture }));
	        sky.position.y =  100 + GROUND_Y;
            sky.position.z = -GROUND_LENGTH / 2;
	        scene.add( sky );
        }

        function createGround() {
            var texture = THREE.ImageUtils.loadTexture('images/sand.jpg');
            texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
            texture.repeat.set(10, 10);
            var ground = new THREE.Mesh( new THREE.PlaneGeometry(GROUND_WIDTH, GROUND_LENGTH), 
			new THREE.MeshBasicMaterial({ color: 0xaaaaaa, ambient: 0x333333, map:texture } ));
            ground.rotation.x = -Math.PI/2;
            ground.position.y = -.02 + GROUND_Y;
            scene.add( ground );
        }

        function createRoad() {
            var texture = THREE.ImageUtils.loadTexture('images/road-rotated.jpg');
            texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
            texture.repeat.set(1, 40);
	        var road = new THREE.Mesh( new THREE.PlaneGeometry(ROAD_WIDTH, ROAD_LENGTH * 2),
			new THREE.MeshBasicMaterial( { color: 0xaaaaaa, shininess:100, ambient: 0x333333, map:texture } ));
            road.rotation.x = -Math.PI/2;
            road.position.y = 0 + GROUND_Y;
            scene.add( road );
        }

        function createPorsche() {
            const gltfLoader = new THREE.GLTFLoader();
            gltfLoader.crossOrigin = true;
            gltfLoader.load("./models/CARGT.glb", (gltf) => {
                const root = gltf.scene;
                root.scale.x = 0.0009
                root.scale.y = 0.0009
                root.scale.z = 0.0009
                root.position.y -= 0.2
                root.position.z = -0.5
                root.position.x += 0.06
                scene.add(root);
                player = root
            })
        }

        function createPickUp() {
            const gltfLoader = new THREE.GLTFLoader();
            gltfLoader.crossOrigin = true;
            gltfLoader.load("./models/Pickup.glb", (gltf) => {
                const root = gltf.scene;
                root.scale.x = 0.0003
                root.scale.y = 0.0003
                root.scale.z = 0.0003
                root.position.y -= 0.2
                root.position.z = -0.5
                root.position.x -= 0.07
                root.rotation.y = Math.PI
                scene.add(root);
                player2 = root
            })
        }

        function createLight() {
            var hemiLight = new THREE.HemisphereLight( 0xffffff, 0xffffff, 0.6 );
            hemiLight.color.setHSL( 0.6, 1, 0.6 );
            hemiLight.groundColor.setHSL( 0.095, 1, 0.75 );
            hemiLight.position.set( 0, 50, 0 );
            scene.add( hemiLight );

            var hemiLightHelper = new THREE.HemisphereLightHelper( hemiLight, 10 );
            scene.add( hemiLightHelper );

            var dirLight = new THREE.DirectionalLight( 0xffffff, 1 );
            dirLight.color.setHSL( 0.1, 1, 0.95 );
            dirLight.position.set( - 1, 1.75, 1 );
            dirLight.position.multiplyScalar( 30 );
            scene.add( dirLight );

            dirLight.castShadow = true;

            dirLight.shadow.mapSize.width = 2048;
            dirLight.shadow.mapSize.height = 2048;

            var d = 50;

            dirLight.shadow.camera.left = - d;
            dirLight.shadow.camera.right = d;
            dirLight.shadow.camera.top = d;
            dirLight.shadow.camera.bottom = - d;

            dirLight.shadow.camera.far = 3500;
            dirLight.shadow.bias = - 0.0001;

            var dirLightHeper = new THREE.DirectionalLightHelper( dirLight, 10 );
            scene.add( dirLightHeper );
        }

        function playAudio() {
            var listener = new THREE.AudioListener();
            camera.add( listener );

            var sound = new THREE.Audio( listener );

            var audioLoader = new THREE.AudioLoader();
            audioLoader.load( 'sounds/Med.mp3', function( buffer ) {
                sound.setBuffer( buffer );
                sound.setLoop( true );
                sound.setVolume( 1 );
                sound.play();
            });

            var audioLoader2 = new THREE.AudioLoader();
            audioLoader2.load( 'sounds/Soft.mp3', function( buffer ) {
                sound.setBuffer( buffer );
                sound.setLoop( true );
                sound.setVolume( 1 );
                sound.play();
            });
        }

    </script>
</body>
</html>